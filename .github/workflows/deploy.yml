name: Deploy Backend to EC2

on:
  push:
    branches:
      - deploy  # Trigger workflow only on push to deploy branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        
      - name: Enable Debug Logging
        run: |
          echo "RUNNER_DEBUG=true" >> $GITHUB_ENV  # âœ… Enable runner debugging
          echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV  # âœ… Enable step debugging
        
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json  # âœ… Correct way

      - name: Install Dependencies
        run: cd backend && npm install

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.HOST_DNS }}
          USER: ubuntu
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          ssh -o StrictHostKeyChecking=no -i private_key.pem $USER@$HOST << 'EOF'
            set -e  # Exit on error
            echo "ðŸ”„ Navigating to project directory..."
            cd mern-chat-app/backend || { echo "âŒ Directory not found"; exit 1; }
            
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin deploy || { echo "âŒ Git pull failed"; exit 1; }
            
            echo "ðŸ“¦ Installing dependencies..."
            npm install || { echo "âŒ npm install failed"; exit 1; }
            
            echo "ðŸš€ Restarting PM2 process..."
            pm2 restart server.js || pm2 start server.js || { echo "âŒ PM2 failed"; exit 1; }
            
            echo "âœ… Deployment completed!"
            exit
          EOF
